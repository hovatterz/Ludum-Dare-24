#!/usr/bin/env ruby
require "rubygems"
require "bundler/setup"
require "gosu"
$LOAD_PATH << File.expand_path("../../lib", __FILE__)
require "roguevolution"

class GameWindow < Gosu::Window
  FONT_HEIGHT = 16

  TILES = {
    :player => 0,
    :wall => 1,
    :floor => 2
  }

  def initialize
    super(640, 480, false)
    self.caption = "Roguevolution - Ludum Dare 24 Project"

    @dungeon = Roguevolution::Dungeon.new(5, 50, 50)
    @dungeon.generate!

    @player = Roguevolution::Player.new

    @tiles = Gosu::Image.load_tiles(self, "media/tiles.png", 32, 32, true)
  end

  def draw
    floor = @dungeon.floors[@player.current_floor]
    floor.each_tile do |x, y|
      tile_type = TILES[floor.tiles[[x, y]].type]
      @tiles[tile_type].draw(x * 32, y * 32, Roguevolution::ZIndex::DUNGEON)
    end

    @tiles[TILES[:player]].draw(@player.x * 32, @player.y * 32, Roguevolution::ZIndex::PLAYER)
  end

  def update
  end

  def button_down(id)
    if [Gosu::KbLeft, Gosu::KbNumpad4, Gosu::KbH].include?(id)
      @player.move(@dungeon, -1, 0)
    elsif [Gosu::KbRight, Gosu::KbNumpad6, Gosu::KbL].include?(id)
      @player.move(@dungeon, 1, 0)
    elsif [Gosu::KbUp, Gosu::KbNumpad8, Gosu::KbK].include?(id)
      @player.move(@dungeon, 0, -1)
    elsif [Gosu::KbDown, Gosu::KbNumpad2, Gosu::KbJ].include?(id)
      @player.move(@dungeon, 0, 1)
    end
  end
end

window = GameWindow.new
window.show
